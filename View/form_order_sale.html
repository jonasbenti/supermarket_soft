<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <title>Pedido {order_id}</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <!-- <script type="text/javascript" src="./View/js/process_order_sale.js"></script>
    <script src="process_order_sale1.js"></script> -->
</head>
<body>  
    <div class="panel panel-primary">
        <div class="panel-heading" style="text-align: center">Pedido <b>{order_id}</b></div>
    </div>  
    <form enctype="multipart/form-data" method="post" action="index.php?class=OrderSaleForm&method=save">
        <input id="order_id" name="order_id" type="hidden" value="{order_id}">
        <div class="container">
            <div class="form-group col-md-4">
                <label>Data</label>
                <input name="order_date" id="order_date" class="form-control" type="text" 
                    value="{order_date}" style="width: 30%" required>
            </div>    
            <div class="form-group col-md-3">
                <label>Valor Total</label>
                <input name="order_total" id="order_total" class="form-control" type="text" 
                style="width: 30%" value="0" readonly="1">
            </div>
            <div class="form-group col-md-3">
                <label>Valor Total de imposto</label>
                <input name="order_total_tax" id="order_total_tax" class="form-control" type="text" 
                style="width: 30%" value="0" readonly="1">
            </div>
        </div>        
        <div id="panel_include" class="panel panel-primary">
            <div class="panel-heading" style="text-align: center">Incluir produto</div>
        </div>
        <div id="div_alert" class="container">
            <div class="alert alert-success alert-dismissible">
                <label id="label_alert"></label>
                <button type="button" class="close" onclick="showHideDiv(div_alert)">&times;</button>
            </div>
        </div>
        <div id="div_include" class="container">
            <div class="container">
                <div class="form-group col-md-3">
                    <label>Produto</label>
                    <select class="form-control" size="1" id="product_item" 
                    name="product_item" onchange="findProduct()">
                        {combo_products}             
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label>Qtd</label>
                    <input id="quantity_item" name="quantity_item" class="form-control"
                    type="number" style="width: 30%" value="1" onblur="calcTotal()" min="1">                    
                </div>
            </div>
            <div class="container">
                <div class="form-group col-md-4">
                    <label>Preço</label>
                    <input id="price_item" name="price_item" class="form-control"
                    type="number" style="width: 30%" value="0" readonly="1">                    
                </div>
                <div class="form-group col-md-4">
                    <label>Total</label>
                    <input id="total_item" name="total_item" class="form-control"
                    type="number" style="width: 30%" value="0" readonly="1">                    
                </div> 
                <div class="form-group col-md-4">
                    <label>Total Imp.</label>
                    <input id="total_tax_item" name="total_tax_item" class="form-control"
                    type="number" style="width: 30%" value="0" readonly="1">                    
                </div>
            </div>
            <input id="order_items" name="order_items" type="hidden" value="">            
        </div>
        <div class="panel panel-primary">
                <div class="panel-heading" style="text-align: center">Opções</div>              
        </div>
        <div style="text-align: center">
            <button type="button" id="btn_add" onclick="addItem()" class="btn btn-primary" href="#panel_include">Add produto</button>
            <a href="index.php?class=OrderSaleList" class="btn btn-info"> Voltar a Lista de pedidos </a>
            <input type="submit" id="btn_submit" class="btn btn-success" onclick="endOrderSale()" value="Finalizar Pedido">
            <button type="button" id="btn_clear" onclick="clearOrderSaleTotalsItems()" class="btn btn-danger">Limpar itens</button>
        </div>
    </form>    
    <br>
    <div id="div_order_items" class="panel panel-primary">
        <div class="panel-heading" style="text-align: center">Itens do pedido</div>
    </div>
    <table id="tbl_order" class="table table-striped table-bordered table-hover">
        <thead class="thead-dark">
            <tr>
                <th style="text-align:center">Excluir</th>
                <th style="text-align:right">Nº</th>
                <th>Produto</th>
                <th style="text-align:right">Qtd</th>
                <th style="text-align:right">Preço</th>
                <th style="text-align:right">Total</th>
                <th style="text-align:right">Total Imp.</th>
            </tr>
        </thead>
    </table>

    <script type="text/javascript">
        //elements
        let elAppTable = document.getElementById("tbl_order");
        var order_items = document.getElementById("order_items");
        var tblOrderBody = document.createElement("tbody");

        //localstorage
        var items_order = JSON.parse(localStorage.getItem("items")) || [];
        var next_number = 0;

        //inputs
        var order_id = document.getElementById("order_id");
        var order_date = document.getElementById("order_date");
        var order_total = document.getElementById("order_total");
        var order_total_tax = document.getElementById("order_total_tax");
        var product_item = document.getElementById("product_item");
        var quantity_item = document.getElementById("quantity_item");  
        var price_item = document.getElementById("price_item");
        var total_item = document.getElementById("total_item");
        var total_tax_item = document.getElementById("total_tax_item");    

        //buttons
        var btn_add = document.getElementById("btn_add");
        var btn_submit = document.getElementById("btn_submit");
        var btn_clear = document.getElementById("btn_clear");

        //divs
        var panel_include = document.getElementById("panel_include");
        var div_include = document.getElementById("div_include");
        var div_alert = document.getElementById("div_alert");

        //label
        var label_alert = document.getElementById("label_alert");

        //variables
        var product_id ;
        var product_desc;
        var pruduct_perc_tax;
        div_alert.style.display = 'none';

        if (order_id.value != "") {
            btn_add.style.display = 'none';
            btn_submit.style.display = 'none';
            btn_clear.style.display = 'none';
            panel_include.style.display = 'none';
            div_include.style.display = 'none';
            items_order = JSON.parse('{array_order_items}') || [];
        }

        createTable(items_order);  

        function removeRow(rowId, id) {
            rowId.remove();
            items_order = items_order.filter(function(obj) {
                return obj.item_number !== id;
            });
            localStorage.setItem('items', JSON.stringify(items_order));
        }

        function showHideDiv(div_show, show = 0) {
            if(div_show.style.display == "none" || show == 1) {
                div_show.style.display = 'block';
                setTimeout(function() {
                    div_show.style.display = 'none';
                }, 4000);
            } else {
                div_show.style.display = 'none';
            }
        }

        function createTable(items) {
            items.sort(function(a, b) {
                    return b.item_number - a.item_number
            });

            tblOrderBody.remove();
            tblOrderBody = document.createElement("tbody");
            total_order = 0;
            total_order_tax = 0;

            for (item of items) {
                let row = document.createElement('tr');
                row.setAttribute("id", "trb"+item.item_number);
                row.innerHTML = `
                <td style="text-align:center">
                    <a href='#div_order_items' onClick='removeRow(trb${item.item_number}, ${item.item_number})'>
                        <img src='View/images/excluir.png' style='width:17px'>
                    </a>                
                </td>
                <td style="text-align:right">${item.item_number}</td>
                <td>${item.product_desc}</td>
                <td style="text-align:right">${item.quantity}</td>
                <td style="text-align:right">${item.price}</td>
                <td style="text-align:right">${item.value_total}</td>
                <td style="text-align:right">${item.value_total_tax}</td>
                `;
                
                total_order += parseFloat(item.value_total);
                total_order_tax += parseFloat(item.value_total_tax);

                update_total_order(total_order, total_order_tax);

                tblOrderBody.appendChild(row);
                elAppTable.appendChild(tblOrderBody);
            }
        }

        function update_total_order(value_total_order, value_total_order_tax) {
            order_total.value = value_total_order;
            order_total_tax.value = value_total_order_tax;
        }

        function findProduct() {
            let produto_selected = product_item.options[product_item.selectedIndex];
            product_id = produto_selected.value;
            product_desc = produto_selected.text;
            pruduct_perc_tax = produto_selected.dataset.tax_percentage;
            price_item.value = produto_selected.dataset.price;
            calcTotal();
        }

        function addItem() {
            if(product_item.selectedIndex == "0" || quantity_item.value < 1 ) {
                alert("É necessario selecionar o produto, e a quantidade precisa ser maior que zero! ");
                return false;
            }
            next_number = JSON.parse(localStorage.getItem("next_number")) || 1;        
            
            items_order.push({
                item_number: next_number,
                product_desc: product_desc,
                product_id: product_id,
                quantity: quantity_item.value,
                price: price_item.value,
                value_total: total_item.value,
                value_total_tax: total_tax_item.value
            });
            localStorage.setItem('items', JSON.stringify(items_order));
            next_number++;        
            localStorage.setItem('next_number', JSON.stringify(next_number));
        
            label_alert.innerHTML = "Foram incluidos "+quantity_item.value+" "+product_desc+" no pedido com sucesso.";
            clearIncludeproduct();
            createTable(items_order);            
            showHideDiv(div_alert, show = 1) 
            window.location.href = "#panel_include";        
        }

        function calcTotal() {
            total_item.value = (quantity_item.value * price_item.value).toFixed(2);
            total_tax_item.value = (total_item.value * (pruduct_perc_tax/100)).toFixed(2);
        }

        function endOrderSale() {
            order_items.value = (localStorage.getItem("items"));
            if(order_items.value.length == 0) {
                alert("erro ao finalizar pedido. É necessario inserir 1 produto no minimo. ");
                return ;
            }
            clearOrderSaleItems();
        }

        function clearOrderSaleItems() {
            tblOrderBody.remove();
            localStorage.clear();
            items_order = [];   
        }

        function clearOrderSaleTotalsItems() {
            order_total.value = 0;     
            order_total_tax.value = 0;  
            clearOrderSaleItems()
        }

        function clearIncludeproduct() {
            product_desc.value = "";
            product_id.value = 0;
            product_item.selectedIndex = "0";
            quantity_item.value = 1;
            price_item.value = 0;
            total_item.value = 0;
            total_tax_item.value = 0;   
        }
    
    </script>
</body>
</html>